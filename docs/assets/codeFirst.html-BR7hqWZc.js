import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,o as a,d as e}from"./app-DZ9bmjCp.js";const n="/kbms/common/1611801961116-4908455e-ee6b-4d90-baba-5a673c7ffa7c.png",t="/kbms/common/1611802002383-03013f37-0582-4615-8231-f5d782515bce.png",l={},h=e(`<h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h2><p>根据项目里面的对象上下文和对象实体类生成数据库，通过程序包管理控制器操作</p><h2 id="安装组件" tabindex="-1"><a class="header-anchor" href="#安装组件"><span>安装组件</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>Microsoft.EntityFrameworkCore.Tools</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>另外不同的数据库还需要安装不同的组件进行迁移数据库的操作<br> MySQL：Pomelo.EntityFrameworkCore.MySql<br> Sql Server：Microsoft.EntityFrameworkCore.SqlServer<br> sqlite：Microsoft.EntityFrameworkCore.Sqlite<br> pgsql：Npgsql.EntityFrameworkCore.PostgreSQL</p><h2 id="创建迁移" tabindex="-1"><a class="header-anchor" href="#创建迁移"><span>创建迁移</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 基础的迁移</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Add-Migration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> InitialCreate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 迁移且显示执行的所有步骤</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Add-Migration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> InitialCreate</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -verbose</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 指定数据库上下文迁移</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Add-Migration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> InitialCreate</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -Context</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> FirstDbContext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -OutputDir</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Migrations</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\F</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">irstDbContextMigrations</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Update-Database</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -Context</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> FirstDbContext</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 简写 add-migration init -c openDbContext -o Migrations\\firstDbContext</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># -Context参数表示要使用的 DbContext 类</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+n+`" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>然后会生成Migrations文件，向<strong>Migrations</strong>目录下的项目添加以下三个文件：</p><ul><li>XXXXXXXXXXXXXX_InitialCreate.cs - 主迁移文件 。 包含应用迁移所需的操作（在 Up() 中）和还原迁移所需的操作（在 Down()中）。</li><li>XXXXXXXXXXXXXX_InitialCreate.Designer.cs - 迁移元数据文件 。 包含 EF 所用的信息。</li><li><strong>MyContextModelSnapshot.cs</strong>--当前模型的快照。 用于确定添加下一迁移时的更改内容。</li></ul><h3 id="迁移指定自定义sql" tabindex="-1"><a class="header-anchor" href="#迁移指定自定义sql"><span>迁移指定自定义SQL</span></a></h3><p>有些复杂的情况，当我们无法通过 EF Fluent API 表达某些内容时，自定义 SQL 命令很有帮助，可以用它来实现将数据从一列迁移到另一列或者定义复杂的操作</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> partial</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Update_Products</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Migration</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> override</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> Up</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">MigrationBuilder</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> migrationBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">        migrationBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Sql</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;&lt;YOUR CUSTOM SQL HERE&gt;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> override</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> Down</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">MigrationBuilder</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> migrationBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        // You are also responsible for reverthing any changes.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="删除迁移" tabindex="-1"><a class="header-anchor" href="#删除迁移"><span>删除迁移</span></a></h2><p>有时候，你可能在添加迁移后意识到需要在应用迁移前对EFCore模型作出其他更改。要删除上个迁移，请使用如下命令</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Remove</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Migration</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>删除迁移后，可对模型作出其他更改，然后再次添加迁移</p><h2 id="还原迁移" tabindex="-1"><a class="header-anchor" href="#还原迁移"><span>还原迁移</span></a></h2><p>如果已对数据库应用一个迁移（或者多个迁移），但还需将其复原，则可使用同一个命令来应用过迁移，并指定回退时候的目标迁移名称。</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Update</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Database</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> LastGoodMigration</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="更新数据库" tabindex="-1"><a class="header-anchor" href="#更新数据库"><span>更新数据库</span></a></h2><p>每次本地更新类代码文件时候，这个时候需要更新数据，那么就需要先删除原先存在的数据库，然后执行命令 Update-Database  --将迁移文件映射生成对应的数据库 <img src="`+t+`" alt="image.png" loading="lazy"> 在执行完以上指令后，数据库中添加了新增加的内容 举例：</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Add</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Migration</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> initCreate1</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">  生成迁移文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Update</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Database</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> initCreate1</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> 将迁移文件映射生成对应的数据库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Add</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Migration</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> initCreate2</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">  生成迁移文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Update</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Database</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> initCreate2</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> 将迁移文件映射生成对应的数据库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Update</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Database</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> initCreate1</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> 数据库会回到initcreate1的迁移</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">，</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">后来增加的东西也会被删除</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Update</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">database</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> openDBContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">  更新指定的上下文文件</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="生成sql脚本" tabindex="-1"><a class="header-anchor" href="#生成sql脚本"><span>生成SQL脚本</span></a></h2><p>调试迁移或将其部署到生产数据库是，生成一个SQL脚本很有帮助，这个时候就需要使用代码生成SQL数据库</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Script</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Migration</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Script</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Migration</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Output</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> d</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">InitialCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">sql</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//生成从版本d到f的脚本</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Script</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Migration</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> d</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> f</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">详细操作</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="运行时候实现迁移" tabindex="-1"><a class="header-anchor" href="#运行时候实现迁移"><span>运行时候实现迁移</span></a></h2><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">myDbContext</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Database</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Migrate</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>运行的时候会先检查有没有数据库，如果没有则会创建数据库，然后如果没有迁移文件执行该命令会生成</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CREATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">__EFMigrationsHistory</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\` (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MigrationId</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\` </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">150</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CHARACTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> utf8mb4</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> NOT</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">ProductVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\` </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CHARACTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> utf8mb4</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> NOT</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    CONSTRAINT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">PK___EFMigrationsHistory</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\` </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">PRIMARY</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MigrationId</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\`)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CHARACTER</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> SET</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> utf8mb4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果存在迁移文件，则会执行迁移文件，并且往迁移记录表添加一条数据。</p><h2 id="删除数据库" tabindex="-1"><a class="header-anchor" href="#删除数据库"><span>删除数据库</span></a></h2><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">dbContext</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Database</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">EnsureDeleted</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.entityframeworkcore.infrastructure.databasefacade.ensuredeleted?view=efcore-5.0" target="_blank" rel="noopener noreferrer">官网文档</a></p></blockquote><h2 id="创建数据库" tabindex="-1"><a class="header-anchor" href="#创建数据库"><span>创建数据库</span></a></h2><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">dbContext</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Database</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">EnsureCreated</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果已经存在数据库，则不执行任何操作。如果数据库不存在(或者该库下没有表)，那么就会创建数据库以及所有架构，并不需要提前生成迁移文件。 如果已经存在数据库，那么会执行下面语句，如果是空库那么就会生成表以及其他结构。</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> CASE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> WHEN</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(*) = 0 THEN FALSE ELSE TRUE END</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">      FROM information_schema.tables</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">      WHERE table_type = &#39;BASE TABLE&#39; AND table_schema = &#39;数据库名字&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果在该语句后面放上myDbContext.Database.Migrate();，则会执行</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CREATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">__EFMigrationsHistory</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\` (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MigrationId</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\` </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">150</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CHARACTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> utf8mb4</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> NOT</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">ProductVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\` </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CHARACTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> utf8mb4</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> NOT</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    CONSTRAINT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">PK___EFMigrationsHistory</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\` </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">PRIMARY</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MigrationId</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">\`)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CHARACTER</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> SET</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> utf8mb4</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.entityframeworkcore.infrastructure.databasefacade.ensurecreated?view=efcore-5.0" target="_blank" rel="noopener noreferrer">官网文档</a></p></blockquote><h2 id="资料" tabindex="-1"><a class="header-anchor" href="#资料"><span>资料</span></a></h2><p>https://learn.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/managing?tabs=vs</p><p>使用多个提供程序进行迁移：https://learn.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/providers?tabs=dotnet-core-cli</p>`,44),k=[h];function r(p,d){return a(),s("div",null,k)}const o=i(l,[["render",r],["__file","codeFirst.html.vue"]]),E=JSON.parse('{"path":"/orm/efcore/migration/codeFirst.html","title":"代码优先","lang":"zh-CN","frontmatter":{"title":"代码优先","lang":"zh-CN","date":"2023-07-16T00:00:00.000Z","publish":true,"author":"azrng","isOriginal":true,"category":["orm"],"tag":["迁移"],"description":"概述 根据项目里面的对象上下文和对象实体类生成数据库，通过程序包管理控制器操作 安装组件 另外不同的数据库还需要安装不同的组件进行迁移数据库的操作 MySQL：Pomelo.EntityFrameworkCore.MySql Sql Server：Microsoft.EntityFrameworkCore.SqlServer sqlite：Micros...","head":[["meta",{"property":"og:url","content":"https://azrng.gitee.io/kbms/kbms/orm/efcore/migration/codeFirst.html"}],["meta",{"property":"og:site_name","content":"知识库"}],["meta",{"property":"og:title","content":"代码优先"}],["meta",{"property":"og:description","content":"概述 根据项目里面的对象上下文和对象实体类生成数据库，通过程序包管理控制器操作 安装组件 另外不同的数据库还需要安装不同的组件进行迁移数据库的操作 MySQL：Pomelo.EntityFrameworkCore.MySql Sql Server：Microsoft.EntityFrameworkCore.SqlServer sqlite：Micros..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://azrng.gitee.io/kbms/kbms/common/1611801961116-4908455e-ee6b-4d90-baba-5a673c7ffa7c.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-07-30T14:08:37.000Z"}],["meta",{"property":"article:author","content":"azrng"}],["meta",{"property":"article:tag","content":"迁移"}],["meta",{"property":"article:published_time","content":"2023-07-16T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-07-30T14:08:37.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"代码优先\\",\\"image\\":[\\"https://azrng.gitee.io/kbms/kbms/common/1611801961116-4908455e-ee6b-4d90-baba-5a673c7ffa7c.png\\",\\"https://azrng.gitee.io/kbms/kbms/common/1611802002383-03013f37-0582-4615-8231-f5d782515bce.png\\"],\\"datePublished\\":\\"2023-07-16T00:00:00.000Z\\",\\"dateModified\\":\\"2024-07-30T14:08:37.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"azrng\\"}]}"]]},"headers":[{"level":2,"title":"概述","slug":"概述","link":"#概述","children":[]},{"level":2,"title":"安装组件","slug":"安装组件","link":"#安装组件","children":[]},{"level":2,"title":"创建迁移","slug":"创建迁移","link":"#创建迁移","children":[{"level":3,"title":"迁移指定自定义SQL","slug":"迁移指定自定义sql","link":"#迁移指定自定义sql","children":[]}]},{"level":2,"title":"删除迁移","slug":"删除迁移","link":"#删除迁移","children":[]},{"level":2,"title":"还原迁移","slug":"还原迁移","link":"#还原迁移","children":[]},{"level":2,"title":"更新数据库","slug":"更新数据库","link":"#更新数据库","children":[]},{"level":2,"title":"生成SQL脚本","slug":"生成sql脚本","link":"#生成sql脚本","children":[]},{"level":2,"title":"运行时候实现迁移","slug":"运行时候实现迁移","link":"#运行时候实现迁移","children":[]},{"level":2,"title":"删除数据库","slug":"删除数据库","link":"#删除数据库","children":[]},{"level":2,"title":"创建数据库","slug":"创建数据库","link":"#创建数据库","children":[]},{"level":2,"title":"资料","slug":"资料","link":"#资料","children":[]}],"git":{"createdTime":1690042937000,"updatedTime":1722348517000,"contributors":[{"name":"azrng","email":"itzhangyunpeng@163.com","commits":1}]},"readingTime":{"minutes":3.75,"words":1126},"filePathRelative":"orm/efcore/migration/codeFirst.md","localizedDate":"2023年7月16日","excerpt":"<h2>概述</h2>\\n<p>根据项目里面的对象上下文和对象实体类生成数据库，通过程序包管理控制器操作</p>\\n<h2>安装组件</h2>\\n<div class=\\"language- line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"\\" data-title=\\"\\" style=\\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes github-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span>Microsoft.EntityFrameworkCore.Tools</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{o as comp,E as data};
