import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,o as e,d as a}from"./app-2OrQE2Jp.js";const n={},t=a(`<h2 id="连接sqlserver2008问题" tabindex="-1"><a class="header-anchor" href="#连接sqlserver2008问题"><span>连接sqlserver2008问题</span></a></h2><h3 id="场景" tabindex="-1"><a class="header-anchor" href="#场景"><span>场景</span></a></h3><p>在使用System.Data.SqlClient(Microsoft.Data.SqlClient只是测试了一次发现也连接不了)连接sqlserver2008的时候在容器部署的情况下报错，因为连接的是甲方的数据库，数据库版本等不能升级或者打补丁</p><h3 id="错误信息" tabindex="-1"><a class="header-anchor" href="#错误信息"><span>错误信息</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>Connection Timeout Expired. The timeout period elapsed during the post-login phase. The connection could have timed out while waiting for server to complete the login process and respond; Or it could have timed out while attempting to create multiple active connections. The duration spent while attempting to connect to this server was - [Pre-Login] initialization=3; handshake=10; [Login] initialization=0; authentication=0; [Post-Login] complete=14074;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>错误信息大致就是这个，配置不同错误信息也不太相同，比如有的错误码31有的35等</p><h3 id="原因" tabindex="-1"><a class="header-anchor" href="#原因"><span>原因</span></a></h3><p>sqlserver2008版本太老，只支持TLSv1协议，不支持TSLV2协议，所以在容器部署的时候一直报错，所以需要降低容器的协议版本</p><h3 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案"><span>解决方案</span></a></h3><p>先修改dockerfile文件，降低容器内tls版本</p><div class="language-dockerfile line-numbers-mode" data-highlighter="shiki" data-ext="dockerfile" data-title="dockerfile" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 如果不支持 tls 1.2，需要修改最低版本。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#61AFEF;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> sed -i </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;s/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> /etc/ssl/openssl.cnf</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#61AFEF;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> sed -i </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;s/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> /usr/lib/ssl/openssl.cnf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>本来以为到这里就可以了，发现还是报错，最后发现.NetCore 的System.Data.SqlClient支持的最低SqlServer版本是2008 r2 SP3,小于这个版本的就会报这个错。来源：https://github.com/dotnet/corefx/issues/9719 到达这里，那么就只好换驱动包了，最后使用了驱动包System.Data.Odbc来操作，示例代码如下</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>var str = &quot;Server=192.168.70.54;Database=cdr;Uid=sa;Pwd=admin123;Encrypt=no;driver=ODBC Driver 18 for SQL Server&quot;;</span></span>
<span class="line"><span>await using var connection = new OdbcConnection(str);</span></span>
<span class="line"><span>connection.Open();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// string sqlQuery = &quot;Select @@version&quot;;</span></span>
<span class="line"><span>// var command = new OdbcCommand(sqlQuery, connection);</span></span>
<span class="line"><span>// var reader = command.ExecuteScalar();</span></span>
<span class="line"><span>// Console.WriteLine(reader.ToString());</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并且dockerfile还得增加东西，需要官网操作去操作即可，linux安装驱动：<a href="https://learn.microsoft.com/zh-cn/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server?view=sql-server-ver16&amp;tabs=alpine18-install%2Calpine17-install%2Cdebian8-install%2Credhat7-13-install%2Crhel7-offline" target="_blank" rel="noopener noreferrer">此处</a> 参考示例</p><p>dockerfile增加下面内容</p><div class="language-dockerfile line-numbers-mode" data-highlighter="shiki" data-ext="dockerfile" data-title="dockerfile" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#61AFEF;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> sed -i </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;s/deb.debian.org/mirrors.aliyun.com/g&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> /etc/apt/sources.list &amp;&amp; apt-get update  &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    apt-get install -y unixodbc unixodbc-dev curl</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#61AFEF;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> curl https://packages.microsoft.com/keys/microsoft.asc |  tee /etc/apt/trusted.gpg.d/microsoft.asc &amp;&amp; curl https://packages.microsoft.com/config/debian/11/prod.list &gt; /etc/apt/sources.list.d/mssql-release.list &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    apt-get update &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ACCEPT_EULA=Y apt-get install -y msodbcsql18 &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    apt-get clean -y &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    rm -rf /var/lib/apt/lists/*</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#61AFEF;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ./ConnectTest/odbcinst.ini /etc/odbcinst.ini</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#61AFEF;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> sed -i </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;s/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> /etc/ssl/openssl.cnf</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#61AFEF;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> sed -i </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;s/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> /usr/lib/ssl/openssl.cnf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中odbcinst.ini内容为</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" data-title="ini" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[ODBC Driver 18 for SQL Server]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;">Microsoft ODBC Driver 18 for SQL Server</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">Driver</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;">/opt/microsoft/msodbcsql18/lib64/libmsodbcsql-18.3.so.2.1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">UsageCount</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;">1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后就可以容器部署服务去连接sqlserver2008了</p><h3 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h3><p>https://learn.microsoft.com/zh-CN/sql/connect/ado-net/sqlclient-troubleshooting-guide?view=sql-server-linux-ver15#login-phase-errors</p><p>连接问题：https://www.cnblogs.com/xiaxiaolu/p/10309064.html</p>`,22),l=[t];function r(p,h){return e(),s("div",null,l)}const c=i(n,[["render",r],["__file","issue.html.vue"]]),k=JSON.parse('{"path":"/orm/adoNet/issue.html","title":"问题","lang":"zh-CN","frontmatter":{"title":"问题","lang":"zh-CN","date":"2023-11-23T00:00:00.000Z","publish":true,"author":"azrng","isOriginal":true,"category":["orm"],"tag":["issue"],"description":"连接sqlserver2008问题 场景 在使用System.Data.SqlClient(Microsoft.Data.SqlClient只是测试了一次发现也连接不了)连接sqlserver2008的时候在容器部署的情况下报错，因为连接的是甲方的数据库，数据库版本等不能升级或者打补丁 错误信息 错误信息大致就是这个，配置不同错误信息也不太相同，比如有...","head":[["meta",{"property":"og:url","content":"https://azrng.gitee.io/kbms/kbms/orm/adoNet/issue.html"}],["meta",{"property":"og:site_name","content":"知识库"}],["meta",{"property":"og:title","content":"问题"}],["meta",{"property":"og:description","content":"连接sqlserver2008问题 场景 在使用System.Data.SqlClient(Microsoft.Data.SqlClient只是测试了一次发现也连接不了)连接sqlserver2008的时候在容器部署的情况下报错，因为连接的是甲方的数据库，数据库版本等不能升级或者打补丁 错误信息 错误信息大致就是这个，配置不同错误信息也不太相同，比如有..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-11-24T16:02:08.000Z"}],["meta",{"property":"article:author","content":"azrng"}],["meta",{"property":"article:tag","content":"issue"}],["meta",{"property":"article:published_time","content":"2023-11-23T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2023-11-24T16:02:08.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"问题\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-11-23T00:00:00.000Z\\",\\"dateModified\\":\\"2023-11-24T16:02:08.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"azrng\\"}]}"]]},"headers":[{"level":2,"title":"连接sqlserver2008问题","slug":"连接sqlserver2008问题","link":"#连接sqlserver2008问题","children":[{"level":3,"title":"场景","slug":"场景","link":"#场景","children":[]},{"level":3,"title":"错误信息","slug":"错误信息","link":"#错误信息","children":[]},{"level":3,"title":"原因","slug":"原因","link":"#原因","children":[]},{"level":3,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[]},{"level":3,"title":"参考资料","slug":"参考资料","link":"#参考资料","children":[]}]}],"git":{"createdTime":1700748859000,"updatedTime":1700841728000,"contributors":[{"name":"azrng","email":"itzhangyunpeng@163.com","commits":2}]},"readingTime":{"minutes":2.05,"words":615},"filePathRelative":"orm/adoNet/issue.md","localizedDate":"2023年11月23日","excerpt":"<h2>连接sqlserver2008问题</h2>\\n<h3>场景</h3>\\n<p>在使用System.Data.SqlClient(Microsoft.Data.SqlClient只是测试了一次发现也连接不了)连接sqlserver2008的时候在容器部署的情况下报错，因为连接的是甲方的数据库，数据库版本等不能升级或者打补丁</p>\\n<h3>错误信息</h3>\\n<div class=\\"language- line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"\\" data-title=\\"\\" style=\\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes github-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span>Connection Timeout Expired. The timeout period elapsed during the post-login phase. The connection could have timed out while waiting for server to complete the login process and respond; Or it could have timed out while attempting to create multiple active connections. The duration spent while attempting to connect to this server was - [Pre-Login] initialization=3; handshake=10; [Login] initialization=0; authentication=0; [Post-Login] complete=14074;</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{c as comp,k as data};
